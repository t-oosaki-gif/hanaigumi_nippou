<!DOCTYPE html>
<html>
<head>
    <base target="_top">
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.10.5/font/bootstrap-icons.css">
    <style>
        body { background-color: #f8f9fa; }
        .container { max-width: 1000px; }
        #report-list-container { max-height: 80vh; overflow-y: auto; }
        .list-group-item-action { cursor: pointer; }
        .modal-body h5 { color: #0d6efd; border-bottom: 2px solid #e7f1ff; padding-bottom: 8px; margin-top: 1.5rem; }
        #loading-overlay {
            position: fixed; top: 0; left: 0; width: 100%; height: 100%;
            background-color: rgba(255, 255, 255, 0.7); display: none;
            justify-content: center; align-items: center; z-index: 1060;
        }
        .table-sm th, .table-sm td { padding: 0.4rem; }
    </style>
</head>
<body>
    <div id="loading-overlay">
        <div class="spinner-border text-primary" role="status"></div>
    </div>

    <div class="container py-4">
        <div class="d-flex justify-content-between align-items-center mb-4">
            <h2 class="mb-0">過去日報一覧</h2>
            <a href="#" id="form-link" class="btn btn-sm btn-outline-secondary">
                <i class="bi bi-pencil-square"></i> 新規入力フォームへ
            </a>
        </div>
        <div class="card">
            <div class="card-body" id="report-list-container">
                <div class="list-group">
                    <!-- 過去日報リストがここに表示されます -->
                </div>
            </div>
        </div>
    </div>
    
    <!-- 詳細表示モーダル -->
    <div class="modal fade" id="detailsModal" tabindex="-1">
      <div class="modal-dialog modal-xl modal-dialog-scrollable">
        <div class="modal-content">
          <div class="modal-header">
            <h5 class="modal-title" id="modal-title">日報詳細</h5>
            <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
          </div>
          <div class="modal-body" id="modal-body-content">
            <!-- 詳細内容がここに表示されます -->
          </div>
          <div class="modal-footer">
            <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">閉じる</button>
          </div>
        </div>
      </div>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
    <script>
        let detailsModal;

        document.addEventListener('DOMContentLoaded', () => {
            showLoading(true);
            google.script.run.withSuccessHandler(onReportsLoaded).withFailureHandler(onFailure).getPastReports();
            google.script.run.withSuccessHandler(url => document.getElementById('form-link').href = url).getWebAppUrl();
            detailsModal = new bootstrap.Modal(document.getElementById('detailsModal'));
        });

        function onReportsLoaded(reports) {
            showLoading(false);
            if(reports.error) { onFailure({message: reports.error}); return; }

            const container = document.querySelector('.list-group');
            container.innerHTML = '';
            if(reports.length === 0) {
                container.innerHTML = '<p class="text-center p-3">登録された日報はありません。</p>';
                return;
            }

            reports.forEach(report => {
                const item = document.createElement('a');
                item.className = 'list-group-item list-group-item-action';
                item.href = '#';
                item.dataset.id = report.id;
                item.innerHTML = `
                    <div class="d-flex w-100 justify-content-between">
                        <h5 class="mb-1">${escapeHtml(report.siteName)}</h5>
                        <small>${escapeHtml(report.date)}</small>
                    </div>
                    <p class="mb-1">工事番号: ${escapeHtml(report.constructionNumber)}</p>
                `;
                item.addEventListener('click', (e) => {
                    e.preventDefault();
                    loadReportDetails(report.id, report.siteName, report.date);
                });
                container.appendChild(item);
            });
        }
        
        function loadReportDetails(reportId, siteName, date) {
            showLoading(true);
            document.getElementById('modal-title').textContent = `${date} - ${siteName}`;
            const body = document.getElementById('modal-body-content');
            body.innerHTML = '';

            google.script.run.withSuccessHandler(details => {
                if(details.error) { onFailure({message: details.error}); return; }
                
                let html = '';
                
                html += '<h5>職員情報</h5>';
                html += '<div class="row"><div class="col-md-7">';
                if(details.employees && details.employees.length > 0) {
                    html += '<table class="table table-sm table-bordered"><thead><tr><th>名前</th><th>勤務</th><th>数量</th></tr></thead><tbody>';
                    details.employees.forEach(d => {
                        html += `<tr><td>${escapeHtml(d.name)}</td><td>${escapeHtml(d.shift)}</td><td>${escapeHtml(d.quantity)}</td></tr>`;
                    });
                    html += '</tbody></table>';
                } else { html += '<p>職員データなし</p>'; }
                html += '</div><div class="col-md-5">';
                 if(details.vehicles && details.vehicles.length > 0) {
                    html += '<table class="table table-sm table-bordered"><thead><tr><th>車両</th><th>数量</th></tr></thead><tbody>';
                    details.vehicles.forEach(d => {
                        html += `<tr><td>${escapeHtml(d.name)}</td><td>${escapeHtml(d.quantity)}</td></tr>`;
                    });
                    html += '</tbody></table>';
                } else { html += '<p>車両データなし</p>'; }
                html += '</div></div>';

                html += '<h5>直営情報</h5>';
                html += '<div class="row"><div class="col-md-7">';
                if(details.directWorkers && details.directWorkers.length > 0) {
                    html += '<table class="table table-sm table-bordered"><thead><tr><th>名前</th><th>勤務</th><th>数量</th></tr></thead><tbody>';
                    details.directWorkers.forEach(d => {
                        html += `<tr><td>${escapeHtml(d.name)}</td><td>${escapeHtml(d.shift)}</td><td>${escapeHtml(d.quantity)}</td></tr>`;
                    });
                    html += '</tbody></table>';
                } else { html += '<p>作業員データなし</p>'; }
                html += '</div><div class="col-md-5">';
                if(details.machinery && details.machinery.length > 0) {
                    html += '<table class="table table-sm table-bordered"><thead><tr><th>使用機械</th><th>数量</th></tr></thead><tbody>';
                    details.machinery.forEach(d => {
                        html += `<tr><td>${escapeHtml(d.name)}</td><td>${escapeHtml(d.quantity)}</td></tr>`;
                    });
                    html += '</tbody></table>';
                } else { html += '<p>機械データなし</p>'; }
                html += '</div></div>';

                html += '<h5>協力業者情報</h5>';
                if(details.subcontractors && details.subcontractors.length > 0) {
                    details.subcontractors.forEach(d => {
                        html += `<div class="card bg-light mb-2"><div class="card-body">
                            <h6 class="card-title">${escapeHtml(d.companyName)} (${escapeHtml(d.count)}名)</h6>
                            <p class="mb-1"><strong>作業内容:</strong> ${escapeHtml(d.workContent) || 'ー'}</p>
                            <p class="mb-0"><strong>使用機械:</strong> ${escapeHtml(d.machinery) || 'ー'}</p>
                        </div></div>`;
                    });
                } else { html += '<p>データなし</p>'; }

                body.innerHTML = html;
                showLoading(false);
                detailsModal.show();
            }).withFailureHandler(onFailure).getReportDetails(reportId);
        }

        function onFailure(error) {
            showLoading(false);
            alert('エラーが発生しました: ' + error.message);
        }
        function showLoading(show) {
            document.getElementById('loading-overlay').style.display = show ? 'flex' : 'none';
        }
        function escapeHtml(str) {
            if (str === null || str === undefined) return '';
            return String(str).replace(/[&<>"']/g, m => ({'&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;',"'":'&#39;'})[m]);
        }
    </script>
</body>
</html>

